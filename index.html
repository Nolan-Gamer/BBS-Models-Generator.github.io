<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BBS Cube Atlas Generator</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="bg"></canvas>
  <main class="card">
    <h1>BBS .bbs.json Générateur (Cube avec texture atlas)</h1>

    <label for="name">Nom du modèle</label>
    <input id="name" placeholder="Ex : bloc-pierre" />

    <label for="desc">Description du bloc (forme, couleur, matière...)</label>
    <textarea id="desc" rows="6" placeholder="Ex : bloc de pierre grise avec veinures blanches..."></textarea>

    <div class="controls">
      <button id="genTexture">Générer l'atlas de texture</button>
      <button id="genModel">Générer et télécharger .bbs.json</button>
    </div>

    <div class="preview">
      <h2>Aperçu atlas (6 faces)</h2>
      <canvas id="texturePreview" width="512" height="512"></canvas>
      <a id="downloadTexture" download="texture.png">Télécharger l'atlas</a>
    </div>

    <p class="hint">L'atlas contient les 6 faces du cube (haut, bas, gauche, droite, avant, arrière).</p>
  </main>

  <script>
  const texCanvas = document.getElementById('texturePreview');
  const texCtx = texCanvas.getContext('2d');
  const descEl = document.getElementById('desc');
  const nameEl = document.getElementById('name');
  const downloadTexture = document.getElementById('downloadTexture');

  function hashString(s){
    let h=2166136261>>>0;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24);
    }
    return h >>> 0;
  }

  function drawFace(x,y,size,hue,label){
    const g = texCtx.createLinearGradient(x,y,x+size,y+size);
    g.addColorStop(0, `hsl(${hue},50%,40%)`);
    g.addColorStop(1, `hsl(${(hue+40)%360},60%,60%)`);
    texCtx.fillStyle = g;
    texCtx.fillRect(x,y,size,size);

    // motif simple
    texCtx.strokeStyle = `hsla(${(hue+180)%360},60%,70%,0.3)`;
    for(let i=0;i<size;i+=size/8){
      texCtx.beginPath();
      texCtx.moveTo(x,y+i);
      texCtx.lineTo(x+size,y+i);
      texCtx.stroke();
    }

    texCtx.font = '10px monospace';
    texCtx.fillStyle = 'rgba(255,255,255,0.3)';
    texCtx.fillText(label, x+4, y+12);
  }

  function generateCubeAtlas(desc){
    const h = hashString(desc);
    const hue = h % 360;
    texCtx.clearRect(0,0,512,512);
    const S = 128;
    // faces disposées en croix (atlas)
    drawFace(S,0,S,hue,'top');
    drawFace(0,S,S,(hue+30)%360,'left');
    drawFace(S,S,S,(hue+60)%360,'front');
    drawFace(2*S,S,S,(hue+90)%360,'right');
    drawFace(3*S,S,S,(hue+120)%360,'back');
    drawFace(S,2*S,S,(hue+150)%360,'bottom');
    return texCanvas.toDataURL('image/png');
  }

  document.getElementById('genTexture').addEventListener('click',()=>{
    const desc = descEl.value || 'bloc';
    const atlas = generateCubeAtlas(desc);
    downloadTexture.href = atlas;
    downloadTexture.download = (nameEl.value || 'bloc') + '.png';
    alert('Atlas généré ! Cliquez sur "Télécharger l\'atlas" pour le sauvegarder.');
  });

  function generateBBSJson(name,desc,atlas){
    return JSON.stringify({
      version: '1.0',
      type: 'cube',
      name: name,
      description: desc,
      generatedAt: new Date().toISOString(),
      texture: atlas,
      uvMapping: 'atlas-3x2'
    },null,2);
  }

  document.getElementById('genModel').addEventListener('click',()=>{
    const name = nameEl.value || 'bloc';
    const desc = descEl.value || '';
    const atlas = generateCubeAtlas(desc);
    const json = generateBBSJson(name,desc,atlas);
    const blob = new Blob([json],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name+'.bbs.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // default
  descEl.value = 'Bloc de pierre grise avec veinures blanches';
  nameEl.value = 'bloc-pierre';
  generateCubeAtlas(descEl.value);
  </script>
</body>
</html>